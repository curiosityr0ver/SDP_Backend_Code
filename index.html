<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Power Monitoring</title>
        <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
            }

            #dataForm {
                margin-bottom: 20px;
            }

            #messages {
                list-style-type: none;
                padding: 0;
            }

            #messages li {
                margin-bottom: 5px;
                border-bottom: 1px solid #ccc;
                padding-bottom: 5px;
            }

            #chartContainer {
                display: flex;
                justify-content: space-between;
                max-width: 1600px;
                margin: 0 auto;
            }

            .chartWrapper {
                width: 48%;
            }

            #optimalSchedule {
                margin-top: 20px;
            }

        </style>
    </head>

    <body>
        <h1>Power Monitoring</h1>
        <form id="dataForm">
            <label for="voltageInput">Voltage:</label>
            <input type="text" id="voltageInput" placeholder="Enter voltage"><br>
            <label for="currentInput">Current:</label>
            <input type="text" id="currentInput" placeholder="Enter current"><br>
            <label for="devicesInput">Number of Devices:</label>
            <input type="text" id="devicesInput" placeholder="Enter number of devices"><br>
            <button type="submit">Send</button>
        </form>
        <ul id="messages"></ul>
        <div id="chartContainer">
            <div class="chartWrapper">
                <canvas id="powerChart"></canvas>
            </div>
            <div class="chartWrapper">
                <canvas id="devicesChart"></canvas>
            </div>
        </div>
        <div id="optimalSchedule">
            <h2>Optimal Schedule for Running Tasks</h2>
            <canvas id="carbonFootprintChart"></canvas>
        </div>

        <script>
            const socket = io('http://localhost:3000');
            const messages = []; // Store received data for chart
            let powerChart = null; // Variable to hold the power chart instance
            let devicesChart = null; // Variable to hold the devices chart instance
            let carbonFootprintChart = null; // Variable to hold the carbon footprint chart instance

            socket.on('connect', () => {
                console.log('Connected to server');
            });

            socket.on('data', (data) => {
                const messageItem = document.createElement('li');
                messageItem.textContent = `Voltage: ${data.voltage}, Current: ${data.current}, Devices: ${data.devices}`;
                document.getElementById('messages').appendChild(messageItem);

                // Store received data for chart
                messages.push({
                    timestamp: new Date().toLocaleTimeString(),
                    power: parseFloat(data.voltage) * parseFloat(data.current),
                    devices: parseInt(data.devices),
                });

                // Update charts with new data
                updateCharts();
            });

            document.getElementById('dataForm').addEventListener('submit', (event) => {
                event.preventDefault();
                const voltage = document.getElementById('voltageInput').value;
                const current = document.getElementById('currentInput').value;
                const devices = document.getElementById('devicesInput').value;
                socket.emit('data', { voltage, current, devices });
            });

            // Function to update the charts
            function updateCharts() {
                if (powerChart !== null) {
                    powerChart.destroy(); // Destroy the existing power chart if it exists
                }
                if (devicesChart !== null) {
                    devicesChart.destroy(); // Destroy the existing devices chart if it exists
                }

                const powerCtx = document.getElementById('powerChart').getContext('2d');
                powerChart = new Chart(powerCtx, {
                    type: 'line',
                    data: {
                        labels: messages.map(msg => msg.timestamp),
                        datasets: [{
                            label: 'Power (W)',
                            data: messages.map(msg => msg.power),
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    stepSize: 1,
                                    displayFormats: {
                                        hour: 'HH:mm'
                                    }
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Time'
                                }
                            }],
                            yAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Power (W)'
                                }
                            }]
                        }
                    }
                });

                const devicesCtx = document.getElementById('devicesChart').getContext('2d');
                devicesChart = new Chart(devicesCtx, {
                    type: 'line',
                    data: {
                        labels: messages.map(msg => msg.timestamp),
                        datasets: [{
                            label: 'Number of Devices',
                            data: messages.map(msg => msg.devices),
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: 'time',
                                time: {
                                    unit: 'hour',
                                    stepSize: 1,
                                    displayFormats: {
                                        hour: 'HH:mm'
                                    }
                                },
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Time'
                                }
                            }],
                            yAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Number of Devices'
                                }
                            }]
                        }
                    }
                });
            }

            // Function to fetch the carbon footprint data and optimal schedule from the server
            async function fetchCarbonFootprintData() {
                try {
                    const response = await axios.get(`http://localhost:3000/optimal-schedule?taskDuration=3`);
                    return response.data;
                } catch (error) {
                    console.error('Error fetching carbon footprint data:', error);
                    return null;
                }
            }

            // Function to create the carbon footprint chart
            function createCarbonFootprintChart(data, optimalSchedule) {
                const ctx = document.getElementById('carbonFootprintChart').getContext('2d');
                const labels = data.map(entry => new Date(entry.timestamp).toLocaleTimeString());
                const carbonFootprint = data.map(entry => parseFloat(entry.voltage) * parseFloat(entry.current));

                const optimalStartIndex = data.findIndex(entry => entry.timestamp === optimalSchedule.start);
                const optimalEndIndex = data.findIndex(entry => entry.timestamp === optimalSchedule.end);

                const backgroundColors = carbonFootprint.map((value, index) =>
                    index >= optimalStartIndex && index <= optimalEndIndex ? 'rgba(75, 192, 192, 0.2)' : 'rgba(255, 99, 132, 0.2)'
                );
                const borderColors = carbonFootprint.map((value, index) =>
                    index >= optimalStartIndex && index <= optimalEndIndex ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'
                );

                carbonFootprintChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Carbon Footprint (gCO2/kWh)',
                            data: carbonFootprint,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Time'
                                }
                            }],
                            yAxes: [{
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Carbon Footprint (gCO2/kWh)'
                                }
                            }]
                        }
                    }
                });
            }

            // Fetch and display the carbon footprint data and optimal schedule when the page loads
            (async () => {
                const result = await fetchCarbonFootprintData();
                if (result) {
                    createCarbonFootprintChart(result.carbonFootprintData, result.optimalSchedule);
                } else {
                    document.getElementById('optimalSchedule').textContent = 'Could not load carbon footprint data.';
                }
            })();
        </script>
    </body>

</html>
